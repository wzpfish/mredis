# Dictionary
## Introduction
Redis中自己实现了Hash字典，类似c++中的unordered_map。hash字典是我用的最多的数据结构之一了，但是里面的实现细节从来就没有深抠过。比如字典的大小（hash数组的大小）何时且如何增长，增长或缩小的时候如何重新hash，重新hash是一次全做完还是分散给不同的操作？。

从redis的dict源码一一解答一下。
* 字典的大小何时且如何增长？
  当在字典中插入数据的时候，有以下几种情况需要增长字典。
  1. 第一次插入，增长字典到初始大小(4)
  2. 字典太满了，即存储的key-value pair个数已经比hash数组大小大好多了，则增长字典大小为pair个数的两倍。这里有个trick，就是字典大小一定是2的平方，这样可以直接hash & mask计算index。

* 如何rehash？
    
    字典里有两个hash数组（1和2），在rehash的时候将1数组里面的元素重新index到2数组里。迁移完成后，将2数组置为1即可。迁移过程中，查询操作在两个数组中进行，插入操作只在2数组中进行。

* rehash一次做完还是分散给不同操作？

    rehash一次做完当然是最方便的，然而这样效率很低，线程需要block住。redis中采用的做法是将rehash的步骤分散到每一个操作中去，比如查询操作前和插入操作前都会rehash一次。这样可以将rehash成本分摊开。